# Defines a server block for handling HTTP requests
server {
    # Listen on port 80 for HTTP traffic (matches docker-compose.yml port mapping 8000:80)
    listen 80;

    # Server name for the host; set to localhost for development as it runs in Docker
    server_name localhost;

    # Sets the document root to Laravel's public directory, where index.php resides
    # Matches the docker-compose.yml volume mount (./:/app)
    root /app/public;

    # Specifies default files to serve; index.php is Laravel's entry point
    index index.php index.html;

    # Sets UTF-8 encoding, standard for Laravel to ensure proper character handling
    charset utf-8;

    # Adds security headers to prevent clickjacking and MIME-type sniffing attacks
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    # Handles all requests, routing them to Laravel's front controller (index.php)
    location / {
        # Tries to serve the requested file or directory; falls back to index.php for Laravel routing
        try_files $uri $uri/ /@vite;
    }

       # Proxy to Vite development server (running locally) for assets
    location @vite {
        proxy_pass http://host.docker.internal:5173;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }


    # Disables logging for favicon.ico to reduce log clutter
    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }

    # Disables logging for robots.txt to reduce log clutter
    location = /robots.txt {
        access_log off;
        log_not_found off;
    }

    # Redirects 404 errors to Laravel's index.php for handling within the application
    error_page 404 /index.php;

    # Handles PHP files, forwarding them to PHP-FPM in the laravel container
    location ~ \.php$ {
        # Connects to PHP-FPM in the laravel service (defined in docker-compose.yml) on port 9000
        fastcgi_pass laravel:9000;
        # Sets index.php as the default PHP file
        fastcgi_index index.php;
        # Passes the full path to the PHP script to PHP-FPM
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        # Includes standard FastCGI parameters for PHP processing
        include fastcgi_params;
        # Hides the X-Powered-By header for security (avoids exposing PHP version)
        fastcgi_hide_header X-Powered-By;
    }

# Denies access to hidden files (e.g., .env, .git) for security, except .well-known
location ~ /\.(?!well-known).* {
    deny all;
}

}  # <-- closes the server block opened at the start
